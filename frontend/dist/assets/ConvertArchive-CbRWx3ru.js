import{r as b,s as W,o as Q,E as u,c as h,a as f,d as n,w as l,e as _,v as X,x as F,b as r,f as C,y as ee,z as v,F as M,h as N,t as S,A as te,g as se,l as B,B as z,G as ne,C as oe,j as le,D as ae}from"./index-CEly86vT.js";import{g as ie,u as re,a as de,d as ce,c as ue,b as pe,e as fe}from"./convert-s7j5aenr.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-B9ygI19o.js";const me={class:"convert-archive"},ve={class:"card-header"},ge={key:0,class:"uploading-section"},ye={class:"upload-item-info"},xe={class:"upload-percent"},he={class:"file-list-section"},Ce={class:"section-header"},Se={key:1,class:"converting-section"},be={class:"task-info"},Fe={class:"task-status"},I="conversion_map_archive",Te=".zip,.rar",we={__name:"ConvertArchive",setup(De){const y=b([]),T=b(!1),g=b([]),m=b([]),x=b(K()),k=W(()=>y.value.filter(e=>["zip","rar"].includes(e.file_type.toLowerCase())));Q(()=>{w()});const w=async()=>{T.value=!0;try{const t=(await ie()).files||[];y.value=t.map(s=>({...s,conversion_id:x.value[s.id]||s.conversion_id}))}catch(e){u.error("获取文件列表失败: "+(e.message||"未知错误"))}finally{T.value=!1}},A=e=>e.size>52428800?(u.error("文件大小不能超过 50MB"),!1):!0,E=async e=>{const{file:t}=e,s=t.uid||Date.now(),p={uid:s,name:t.name,percent:0,status:""};g.value.push(p);try{await re(t,d=>{const i=g.value.find(c=>c.uid===s);i&&(i.percent=d)});const a=g.value.find(d=>d.uid===s);a&&(a.status="success"),u.success(`文件 ${t.name} 上传成功`),setTimeout(()=>{const d=g.value.findIndex(i=>i.uid===s);d>-1&&g.value.splice(d,1)},2e3),w()}catch(a){const d=g.value.find(i=>i.uid===s);d&&(d.status="exception"),u.error("上传失败: "+(a.message||"未知错误"))}},P=async e=>{try{const t={file_id:e.id,fileName:e.original_name,progress:0,status:"processing",statusText:"解压并转换中...",conversion_id:null};m.value.push(t),u.info("正在解压并转换压缩包内的文件，可能需要较长时间，请耐心等待...");const s=await ue(e.id);t.conversion_id=s.conversion_id,await O(t)}catch(t){u.error(`转换失败: ${t.message||"未知错误"}`);const s=m.value.findIndex(p=>p.file_id===e.id);s>-1&&(m.value[s].status="failed",m.value[s].statusText="转换失败",m.value[s].progress=0)}},O=async e=>{let s=0;const p=async()=>{try{const a=await fe(e.conversion_id);if(e.progress=a.progress||50,e.statusText=G(a.status),a.status==="completed"){e.status="completed",e.progress=100;const d=a.error_message||`${e.fileName} 转换完成`;u.success(d);const i=y.value.findIndex(c=>c.id===e.file_id);i>-1&&(y.value[i].status="converted",y.value[i].conversion_id=e.conversion_id),Y(e.file_id,e.conversion_id),setTimeout(()=>{const c=m.value.findIndex(D=>D.file_id===e.file_id);c>-1&&m.value.splice(c,1)},2e3);return}if(a.status==="failed"){e.status="failed",e.statusText=a.error_message||"转换失败",u.error(`${e.fileName} 转换失败: ${a.error_message||"未知错误"}`);return}s++,s<60?setTimeout(p,2e3):(e.status="failed",e.statusText="转换超时",u.error(`${e.fileName} 转换超时`))}catch(a){e.status="failed",e.statusText="查询状态失败",console.error("查询转换状态失败",a)}};await p()},L=e=>{const t=pe(e),s=document.createElement("a");s.href=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),u.success("开始下载 PDF包")},R=e=>{const t=de(e.id),s=document.createElement("a");s.href=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),u.success("开始下载原文件")},U=async e=>{try{await ae.confirm(`确认删除文件"${e.original_name}"吗？删除后无法恢复。`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await ce(e.id),y.value=y.value.filter(s=>s.id!==e.id);const t={...x.value};delete t[e.id],x.value=t,localStorage.setItem(I,JSON.stringify(x.value)),u.success("已删除原文件")}catch(t){t!=="cancel"&&u.error("删除失败: "+(t.message||"未知错误"))}},V=e=>e?e<1024?e+" B":e<1024*1024?(e/1024).toFixed(2)+" KB":(e/(1024*1024)).toFixed(2)+" MB":"0 B",J=e=>{if(!e)return"";const t=new Date(e),s=t.getFullYear(),p=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),d=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0"),c=String(t.getSeconds()).padStart(2,"0");return`${s}-${p}-${a} ${d}:${i}:${c}`},G=e=>({pending:"等待中...",processing:"转换中...",completed:"转换完成",failed:"转换失败"})[e]||e;function K(){try{const e=localStorage.getItem(I);return e?JSON.parse(e):{}}catch(e){return console.error("加载本地 conversion_map 失败",e),{}}}function Y(e,t){x.value={...x.value,[e]:t},localStorage.setItem(I,JSON.stringify(x.value))}return(e,t)=>{const s=_("el-icon"),p=_("el-alert"),a=_("el-upload"),d=_("el-progress"),i=_("el-button"),c=_("el-table-column"),D=_("el-tag"),Z=_("el-table"),j=_("el-divider"),q=_("el-card"),H=X("loading");return f(),h("div",me,[n(q,null,{header:l(()=>[r("div",ve,[n(s,null,{default:l(()=>[n(C(le))]),_:1}),t[0]||(t[0]=r("span",null,"压缩包转 PDF",-1))])]),default:l(()=>[n(p,{title:"功能说明",type:"info",description:"上传压缩包（ZIP/RAR），系统会自动将包内的 Word、图片、OFD 文件转换为 PDF 并重新打包。",closable:!1,style:{"margin-bottom":"20px"}}),n(a,{class:"upload-demo",drag:"",multiple:!0,accept:Te,"before-upload":A,"http-request":E,"show-file-list":!1,"auto-upload":!0,style:{"margin-bottom":"20px"}},{tip:l(()=>[...t[1]||(t[1]=[r("div",{class:"el-upload__tip"}," 仅支持 ZIP、RAR，单个文件不超过 50MB ",-1)])]),default:l(()=>[n(s,{class:"el-icon--upload"},{default:l(()=>[n(C(ee))]),_:1}),t[2]||(t[2]=r("div",{class:"el-upload__text"},[v(" 将文件拖到此处，或 "),r("em",null,"点击上传")],-1))]),_:1}),g.value.length>0?(f(),h("div",ge,[t[3]||(t[3]=r("h3",null,"正在上传",-1)),(f(!0),h(M,null,N(g.value,o=>(f(),h("div",{key:o.uid,class:"upload-item"},[r("div",ye,[r("span",null,S(o.name),1),r("span",xe,S(o.percent)+"%",1)]),n(d,{percentage:o.percent,status:o.status},null,8,["percentage","status"])]))),128))])):F("",!0),r("div",he,[r("div",Ce,[t[5]||(t[5]=r("h3",null,"压缩包文件列表",-1)),n(i,{type:"primary",size:"small",onClick:w},{default:l(()=>[n(s,null,{default:l(()=>[n(C(se))]),_:1}),t[4]||(t[4]=v(" 刷新列表 ",-1))]),_:1})]),te((f(),B(Z,{data:k.value,style:{width:"100%"},"empty-text":"暂无压缩包文件"},{default:l(()=>[n(c,{prop:"original_name",label:"文件名","min-width":"200"}),n(c,{prop:"file_size",label:"大小",width:"120"},{default:l(({row:o})=>[v(S(V(o.file_size)),1)]),_:1}),n(c,{prop:"file_type",label:"类型",width:"100"},{default:l(({row:o})=>[n(D,{size:"small"},{default:l(()=>[v(S(o.file_type.toUpperCase()),1)]),_:2},1024)]),_:1}),n(c,{prop:"created_at",label:"上传时间",width:"180"},{default:l(({row:o})=>[v(S(J(o.created_at)),1)]),_:1}),n(c,{label:"操作",width:"320",fixed:"right"},{default:l(({row:o})=>[n(i,{link:"",type:"primary",size:"small",onClick:$=>R(o)},{default:l(()=>[n(s,null,{default:l(()=>[n(C(z))]),_:1}),t[6]||(t[6]=v(" 下载原文件 ",-1))]),_:1},8,["onClick"]),n(i,{link:"",type:"danger",size:"small",onClick:$=>U(o)},{default:l(()=>[n(s,null,{default:l(()=>[n(C(ne))]),_:1}),t[7]||(t[7]=v(" 删除原文件 ",-1))]),_:1},8,["onClick"]),t[10]||(t[10]=r("br",null,null,-1)),o.status!=="converted"&&o.status!=="converting"?(f(),B(i,{key:0,link:"",type:"primary",size:"small",onClick:$=>P(o)},{default:l(()=>[n(s,null,{default:l(()=>[n(C(oe))]),_:1}),t[8]||(t[8]=v(" 转换为PDF包 ",-1))]),_:1},8,["onClick"])):F("",!0),o.conversion_id?(f(),B(i,{key:1,link:"",type:"success",size:"small",onClick:$=>L(o.conversion_id)},{default:l(()=>[n(s,null,{default:l(()=>[n(C(z))]),_:1}),t[9]||(t[9]=v(" 下载PDF包 ",-1))]),_:1},8,["onClick"])):F("",!0)]),_:1})]),_:1},8,["data"])),[[H,T.value]])]),n(j),m.value.length>0?(f(),h("div",Se,[t[11]||(t[11]=r("h3",null,"转换进度",-1)),(f(!0),h(M,null,N(m.value,o=>(f(),h("div",{key:o.file_id,class:"convert-task"},[r("div",be,[r("span",null,S(o.fileName),1),r("span",Fe,S(o.statusText),1)]),n(d,{percentage:o.progress,status:o.status==="failed"?"exception":o.status==="completed"?"success":""},null,8,["percentage","status"])]))),128))])):F("",!0)]),_:1})])}}},Ne=_e(we,[["__scopeId","data-v-8428cedf"]]);export{Ne as default};
