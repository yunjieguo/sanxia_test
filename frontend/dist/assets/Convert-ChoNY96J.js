import{r as w,s as ne,o as oe,E as c,c as y,a as u,d as n,w as l,e as p,v as le,x as T,b as i,f as h,y as ae,z as _,F as $,h as O,t as b,A as ie,g as re,l as M,B as z,C as E,i as de,D as ce}from"./index-kUKhpTX8.js";import{g as ue,u as pe,a as fe,d as _e,c as me,b as ve,e as ge}from"./convert-DrRAiQHq.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-B9ygI19o.js";const xe={class:"convert-page"},Ce={class:"card-header"},he={key:0,class:"uploading-section"},be={class:"upload-item-info"},we={class:"upload-percent"},Te={class:"file-list-section"},De={class:"section-header"},Se={key:0,class:"batch-actions"},Fe={key:1,class:"converting-section"},Be={class:"task-info"},Me={class:"task-status"},I="conversion_map_word",Ie=".doc,.docx",Ne={__name:"Convert",setup(ke){const x=w([]),D=w([]),S=w(!1),m=w([]),g=w([]),C=w(j()),P=ne(()=>x.value.filter(e=>["doc","docx"].includes(e.file_type.toLowerCase())));oe(()=>{F()});const F=async()=>{S.value=!0;try{const t=(await ue()).files||[];x.value=t.map(s=>({...s,conversion_id:C.value[s.id]||s.conversion_id}))}catch(e){c.error("获取文件列表失败: "+(e.message||"未知错误"))}finally{S.value=!1}},L=e=>e.size>52428800?(c.error("文件大小不能超过 50MB"),!1):!0,U=async e=>{const{file:t}=e,s=t.uid||Date.now(),v={uid:s,name:t.name,percent:0,status:""};g.value.push(v);try{await pe(t,r=>{const a=g.value.find(f=>f.uid===s);a&&(a.percent=r)});const d=g.value.find(r=>r.uid===s);d&&(d.status="success"),c.success(`文件 ${t.name} 上传成功`),setTimeout(()=>{const r=g.value.findIndex(a=>a.uid===s);r>-1&&g.value.splice(r,1)},2e3),F()}catch(d){const r=g.value.find(a=>a.uid===s);r&&(r.status="exception"),c.error("上传失败: "+(d.message||"未知错误"))}},A=e=>{D.value=e},N=async e=>{try{const t={file_id:e.id,fileName:e.original_name,progress:0,status:"processing",statusText:"转换中...",conversion_id:null};m.value.push(t);const s=await me(e.id);t.conversion_id=s.conversion_id,await J(t)}catch(t){c.error(`转换失败: ${t.message||"未知错误"}`);const s=m.value.findIndex(v=>v.file_id===e.id);s>-1&&(m.value[s].status="failed",m.value[s].statusText="转换失败",m.value[s].progress=0)}},V=async()=>{for(const e of D.value)await N(e),await new Promise(t=>setTimeout(t,500))},J=async e=>{let s=0;const v=async()=>{try{const d=await ge(e.conversion_id);if(e.progress=d.progress||0,e.statusText=Y(d.status),d.status==="completed"){e.status="completed",e.progress=100,c.success(`${e.fileName} 转换成功`);const r=x.value.findIndex(a=>a.id===e.file_id);r>-1&&(x.value[r].status="converted",x.value[r].conversion_id=e.conversion_id),H(e.file_id,e.conversion_id),setTimeout(()=>{const a=m.value.findIndex(f=>f.file_id===e.file_id);a>-1&&m.value.splice(a,1)},2e3);return}if(d.status==="failed"){e.status="failed",e.statusText=d.error_message||"转换失败",c.error(`${e.fileName} 转换失败`);return}s++,s<30?setTimeout(v,1e3):(e.status="failed",e.statusText="转换超时",c.error(`${e.fileName} 转换超时`))}catch(d){e.status="failed",e.statusText="查询状态失败",console.error("查询转换状态失败",d)}};await v()},W=e=>{const t=ve(e),s=document.createElement("a");s.href=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),c.success("开始下载 PDF")},K=e=>{const t=fe(e.id),s=document.createElement("a");s.href=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),c.success("开始下载原文件")},X=async e=>{try{await ce.confirm(`确认删除文件"${e.original_name}"吗？删除后无法恢复。`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await _e(e.id),x.value=x.value.filter(s=>s.id!==e.id);const t={...C.value};delete t[e.id],C.value=t,localStorage.setItem(I,JSON.stringify(C.value)),c.success("已删除原文件")}catch(t){t!=="cancel"&&c.error("删除失败: "+(t.message||"未知错误"))}},q=e=>e?e<1024?e+" B":e<1024*1024?(e/1024).toFixed(2)+" KB":(e/(1024*1024)).toFixed(2)+" MB":"0 B",G=e=>({uploaded:"info",converting:"warning",converted:"success",failed:"danger"})[e]||"info",R=e=>({uploaded:"待转换",converting:"转换中",converted:"已转换",failed:"失败"})[e]||e,Y=e=>({pending:"等待中...",processing:"转换中...",completed:"转换完成",failed:"转换失败"})[e]||e;function j(){try{const e=localStorage.getItem(I);return e?JSON.parse(e):{}}catch(e){return console.error("加载本地 conversion_map 失败",e),{}}}function H(e,t){C.value={...C.value,[e]:t};try{localStorage.setItem(I,JSON.stringify(C.value))}catch(s){console.error("保存本地 conversion_map 失败",s)}}return(e,t)=>{const s=p("el-icon"),v=p("el-alert"),d=p("el-upload"),r=p("el-progress"),a=p("el-button"),f=p("el-table-column"),k=p("el-tag"),Q=p("Delete"),Z=p("el-table"),ee=p("el-divider"),te=p("el-card"),se=le("loading");return u(),y("div",xe,[n(te,null,{header:l(()=>[i("div",Ce,[n(s,null,{default:l(()=>[n(h(de))]),_:1}),t[0]||(t[0]=i("span",null,"Word 转 PDF",-1))])]),default:l(()=>[n(v,{title:"功能说明",type:"info",description:"上传 Word 文档后，可选择已上传记录进行 PDF 转换。仅支持 DOC、DOCX。",closable:!1,style:{"margin-bottom":"20px"}}),n(d,{class:"upload-demo",drag:"",multiple:!0,accept:Ie,"before-upload":L,"http-request":U,"show-file-list":!1,"auto-upload":!0,style:{"margin-bottom":"20px"}},{tip:l(()=>[...t[1]||(t[1]=[i("div",{class:"el-upload__tip"}," 仅支持 DOC、DOCX，单个文件不超过 50MB ",-1)])]),default:l(()=>[n(s,{class:"el-icon--upload"},{default:l(()=>[n(h(ae))]),_:1}),t[2]||(t[2]=i("div",{class:"el-upload__text"},[_(" 将文件拖到此处，或 "),i("em",null,"点击上传")],-1))]),_:1}),g.value.length>0?(u(),y("div",he,[t[3]||(t[3]=i("h3",null,"正在上传",-1)),(u(!0),y($,null,O(g.value,o=>(u(),y("div",{key:o.uid,class:"upload-item"},[i("div",be,[i("span",null,b(o.name),1),i("span",we,b(o.percent)+"%",1)]),n(r,{percentage:o.percent,status:o.status},null,8,["percentage","status"])]))),128))])):T("",!0),i("div",Te,[i("div",De,[t[5]||(t[5]=i("h3",null,"选择要转换的文件",-1)),n(a,{type:"primary",size:"small",onClick:F},{default:l(()=>[n(s,null,{default:l(()=>[n(h(re))]),_:1}),t[4]||(t[4]=_(" 刷新列表 ",-1))]),_:1})]),ie((u(),M(Z,{data:P.value,style:{width:"100%"},onSelectionChange:A,"empty-text":"暂无可用 Word 文件"},{default:l(()=>[n(f,{type:"selection",width:"55"}),n(f,{prop:"original_name",label:"文件名","min-width":"200"}),n(f,{prop:"file_size",label:"大小",width:"120"},{default:l(({row:o})=>[_(b(q(o.file_size)),1)]),_:1}),n(f,{prop:"file_type",label:"类型",width:"100"},{default:l(({row:o})=>[n(k,{size:"small"},{default:l(()=>[_(b(o.file_type.toUpperCase()),1)]),_:2},1024)]),_:1}),n(f,{label:"状态",width:"120"},{default:l(({row:o})=>[n(k,{type:G(o.status),size:"small"},{default:l(()=>[_(b(R(o.status)),1)]),_:2},1032,["type"])]),_:1}),n(f,{label:"操作",width:"260",fixed:"right"},{default:l(({row:o})=>[n(a,{link:"",type:"primary",size:"small",onClick:B=>K(o)},{default:l(()=>[n(s,null,{default:l(()=>[n(h(z))]),_:1}),t[6]||(t[6]=_(" 下载原文件 ",-1))]),_:1},8,["onClick"]),n(a,{link:"",type:"danger",size:"small",onClick:B=>X(o)},{default:l(()=>[n(s,null,{default:l(()=>[n(Q)]),_:1}),t[7]||(t[7]=_(" 删除原文件 ",-1))]),_:1},8,["onClick"]),t[10]||(t[10]=i("br",null,null,-1)),o.status!=="converted"&&o.status!=="converting"?(u(),M(a,{key:0,link:"",type:"primary",size:"small",onClick:B=>N(o)},{default:l(()=>[n(s,null,{default:l(()=>[n(h(E))]),_:1}),t[8]||(t[8]=_(" 转换为PDF ",-1))]),_:1},8,["onClick"])):T("",!0),o.conversion_id?(u(),M(a,{key:1,link:"",type:"success",size:"small",onClick:B=>W(o.conversion_id)},{default:l(()=>[n(s,null,{default:l(()=>[n(h(z))]),_:1}),t[9]||(t[9]=_(" 下载PDF ",-1))]),_:1},8,["onClick"])):T("",!0)]),_:1})]),_:1},8,["data"])),[[se,S.value]]),D.value.length>0?(u(),y("div",Se,[n(v,{title:`已选择 ${D.value.length} 个文件`,type:"success",closable:!1},null,8,["title"]),n(a,{type:"primary",onClick:V},{default:l(()=>[n(s,null,{default:l(()=>[n(h(E))]),_:1}),t[11]||(t[11]=_(" 批量转换 ",-1))]),_:1})])):T("",!0)]),n(ee),m.value.length>0?(u(),y("div",Fe,[t[12]||(t[12]=i("h3",null,"转换进度",-1)),(u(!0),y($,null,O(m.value,o=>(u(),y("div",{key:o.file_id,class:"convert-task"},[i("div",Be,[i("span",null,b(o.fileName),1),i("span",Me,b(o.statusText),1)]),n(r,{percentage:o.progress,status:o.status==="failed"?"exception":o.status==="completed"?"success":""},null,8,["percentage","status"])]))),128))])):T("",!0)]),_:1})])}}},Pe=ye(Ne,[["__scopeId","data-v-6d7b6a8c"]]);export{Pe as default};
