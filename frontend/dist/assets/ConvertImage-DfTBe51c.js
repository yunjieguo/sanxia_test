import{r as w,s as ne,o as le,E as c,c as y,a as d,d as n,w as o,e as p,v as oe,x as T,b as i,f as C,y as ae,z as m,F as k,h as $,t as b,A as ie,g as re,l as M,B as E,C as z,p as ue,D as ce}from"./index-CEly86vT.js";import{g as de,u as pe,a as fe,d as me,c as _e,b as ve,e as ge}from"./convert-s7j5aenr.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-B9ygI19o.js";const xe={class:"convert-page"},he={class:"card-header"},Ce={key:0,class:"uploading-section"},be={class:"upload-item-info"},we={class:"upload-percent"},Te={class:"file-list-section"},Fe={class:"section-header"},Se={key:0,class:"batch-actions"},Be={key:1,class:"converting-section"},Ie={class:"task-info"},Me={class:"task-status"},D="conversion_map_image",De=".png,.jpg,.jpeg,.gif,.bmp",Pe={__name:"ConvertImage",setup(Ne){const x=w([]),F=w([]),S=w(!1),_=w([]),g=w([]),h=w(Q()),G=ne(()=>x.value.filter(e=>["png","jpg","jpeg","gif","bmp"].includes(e.file_type.toLowerCase())));le(()=>{B()});const B=async()=>{S.value=!0;try{const t=(await de()).files||[];x.value=t.map(s=>({...s,conversion_id:h.value[s.id]||s.conversion_id}))}catch(e){c.error("获取文件列表失败: "+(e.message||"未知错误"))}finally{S.value=!1}},J=e=>e.size>52428800?(c.error("文件大小不能超过 50MB"),!1):!0,O=async e=>{const{file:t}=e,s=t.uid||Date.now(),v={uid:s,name:t.name,percent:0,status:""};g.value.push(v);try{await pe(t,r=>{const a=g.value.find(f=>f.uid===s);a&&(a.percent=r)});const u=g.value.find(r=>r.uid===s);u&&(u.status="success"),c.success(`文件 ${t.name} 上传成功`),setTimeout(()=>{const r=g.value.findIndex(a=>a.uid===s);r>-1&&g.value.splice(r,1)},2e3),B()}catch(u){const r=g.value.find(a=>a.uid===s);r&&(r.status="exception"),c.error("上传失败: "+(u.message||"未知错误"))}},L=e=>{F.value=e},P=async e=>{try{const t={file_id:e.id,fileName:e.original_name,progress:0,status:"processing",statusText:"转换中...",conversion_id:null};_.value.push(t);const s=await _e(e.id);t.conversion_id=s.conversion_id,await j(t)}catch(t){c.error(`转换失败: ${t.message||"未知错误"}`);const s=_.value.findIndex(v=>v.file_id===e.id);s>-1&&(_.value[s].status="failed",_.value[s].statusText="转换失败",_.value[s].progress=0)}},U=async()=>{for(const e of F.value)await P(e),await new Promise(t=>setTimeout(t,500))},j=async e=>{let s=0;const v=async()=>{try{const u=await ge(e.conversion_id);if(e.progress=u.progress||0,e.statusText=H(u.status),u.status==="completed"){e.status="completed",e.progress=100,c.success(`${e.fileName} 转换成功`);const r=x.value.findIndex(a=>a.id===e.file_id);r>-1&&(x.value[r].status="converted",x.value[r].conversion_id=e.conversion_id),W(e.file_id,e.conversion_id),setTimeout(()=>{const a=_.value.findIndex(f=>f.file_id===e.file_id);a>-1&&_.value.splice(a,1)},2e3);return}if(u.status==="failed"){e.status="failed",e.statusText=u.error_message||"转换失败",c.error(`${e.fileName} 转换失败`);return}s++,s<30?setTimeout(v,1e3):(e.status="failed",e.statusText="转换超时",c.error(`${e.fileName} 转换超时`))}catch(u){e.status="failed",e.statusText="查询状态失败",console.error("查询转换状态失败",u)}};await v()},A=e=>{const t=ve(e),s=document.createElement("a");s.href=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),c.success("开始下载 PDF")},V=e=>{const t=fe(e.id),s=document.createElement("a");s.href=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),c.success("开始下载原文件")},K=async e=>{try{await ce.confirm(`确认删除文件"${e.original_name}"吗？删除后无法恢复。`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await me(e.id),x.value=x.value.filter(s=>s.id!==e.id);const t={...h.value};delete t[e.id],h.value=t,localStorage.setItem(D,JSON.stringify(h.value)),c.success("已删除原文件")}catch(t){t!=="cancel"&&c.error("删除失败: "+(t.message||"未知错误"))}},q=e=>e?e<1024?e+" B":e<1024*1024?(e/1024).toFixed(2)+" KB":(e/(1024*1024)).toFixed(2)+" MB":"0 B",R=e=>({uploaded:"info",converting:"warning",converted:"success",failed:"danger"})[e]||"info",Y=e=>({uploaded:"待转换",converting:"转换中",converted:"已转换",failed:"失败"})[e]||e,H=e=>({pending:"等待中...",processing:"转换中...",completed:"转换完成",failed:"转换失败"})[e]||e;function Q(){try{const e=localStorage.getItem(D);return e?JSON.parse(e):{}}catch(e){return console.error("加载本地 conversion_map 失败",e),{}}}function W(e,t){h.value={...h.value,[e]:t};try{localStorage.setItem(D,JSON.stringify(h.value))}catch(s){console.error("保存本地 conversion_map 失败",s)}}return(e,t)=>{const s=p("el-icon"),v=p("el-alert"),u=p("el-upload"),r=p("el-progress"),a=p("el-button"),f=p("el-table-column"),N=p("el-tag"),X=p("Delete"),Z=p("el-table"),ee=p("el-divider"),te=p("el-card"),se=oe("loading");return d(),y("div",xe,[n(te,null,{header:o(()=>[i("div",he,[n(s,null,{default:o(()=>[n(C(ue))]),_:1}),t[0]||(t[0]=i("span",null,"图片转 PDF",-1))])]),default:o(()=>[n(v,{title:"功能说明",type:"info",description:"上传图片后，可选择已上传记录进行 PDF 转换。支持 PNG、JPG、JPEG、GIF、BMP。",closable:!1,style:{"margin-bottom":"20px"}}),n(u,{class:"upload-demo",drag:"",multiple:!0,accept:De,"before-upload":J,"http-request":O,"show-file-list":!1,"auto-upload":!0,style:{"margin-bottom":"20px"}},{tip:o(()=>[...t[1]||(t[1]=[i("div",{class:"el-upload__tip"}," 支持 PNG、JPG、JPEG、GIF、BMP，单个文件不超过 50MB ",-1)])]),default:o(()=>[n(s,{class:"el-icon--upload"},{default:o(()=>[n(C(ae))]),_:1}),t[2]||(t[2]=i("div",{class:"el-upload__text"},[m(" 将文件拖到此处，或 "),i("em",null,"点击上传")],-1))]),_:1}),g.value.length>0?(d(),y("div",Ce,[t[3]||(t[3]=i("h3",null,"正在上传",-1)),(d(!0),y(k,null,$(g.value,l=>(d(),y("div",{key:l.uid,class:"upload-item"},[i("div",be,[i("span",null,b(l.name),1),i("span",we,b(l.percent)+"%",1)]),n(r,{percentage:l.percent,status:l.status},null,8,["percentage","status"])]))),128))])):T("",!0),i("div",Te,[i("div",Fe,[t[5]||(t[5]=i("h3",null,"选择要转换的文件",-1)),n(a,{type:"primary",size:"small",onClick:B},{default:o(()=>[n(s,null,{default:o(()=>[n(C(re))]),_:1}),t[4]||(t[4]=m(" 刷新列表 ",-1))]),_:1})]),ie((d(),M(Z,{data:G.value,style:{width:"100%"},onSelectionChange:L,"empty-text":"暂无可用图片文件"},{default:o(()=>[n(f,{type:"selection",width:"55"}),n(f,{prop:"original_name",label:"文件名","min-width":"200"}),n(f,{prop:"file_size",label:"大小",width:"120"},{default:o(({row:l})=>[m(b(q(l.file_size)),1)]),_:1}),n(f,{prop:"file_type",label:"类型",width:"100"},{default:o(({row:l})=>[n(N,{size:"small"},{default:o(()=>[m(b(l.file_type.toUpperCase()),1)]),_:2},1024)]),_:1}),n(f,{label:"状态",width:"120"},{default:o(({row:l})=>[n(N,{type:R(l.status),size:"small"},{default:o(()=>[m(b(Y(l.status)),1)]),_:2},1032,["type"])]),_:1}),n(f,{label:"操作",width:"260",fixed:"right"},{default:o(({row:l})=>[n(a,{link:"",type:"primary",size:"small",onClick:I=>V(l)},{default:o(()=>[n(s,null,{default:o(()=>[n(C(E))]),_:1}),t[6]||(t[6]=m(" 下载原文件 ",-1))]),_:1},8,["onClick"]),n(a,{link:"",type:"danger",size:"small",onClick:I=>K(l)},{default:o(()=>[n(s,null,{default:o(()=>[n(X)]),_:1}),t[7]||(t[7]=m(" 删除原文件 ",-1))]),_:1},8,["onClick"]),t[10]||(t[10]=i("br",null,null,-1)),l.status!=="converted"&&l.status!=="converting"?(d(),M(a,{key:0,link:"",type:"primary",size:"small",onClick:I=>P(l)},{default:o(()=>[n(s,null,{default:o(()=>[n(C(z))]),_:1}),t[8]||(t[8]=m(" 转换为PDF ",-1))]),_:1},8,["onClick"])):T("",!0),l.conversion_id?(d(),M(a,{key:1,link:"",type:"success",size:"small",onClick:I=>A(l.conversion_id)},{default:o(()=>[n(s,null,{default:o(()=>[n(C(E))]),_:1}),t[9]||(t[9]=m(" 下载PDF ",-1))]),_:1},8,["onClick"])):T("",!0)]),_:1})]),_:1},8,["data"])),[[se,S.value]]),F.value.length>0?(d(),y("div",Se,[n(v,{title:`已选择 ${F.value.length} 个文件`,type:"success",closable:!1},null,8,["title"]),n(a,{type:"primary",onClick:U},{default:o(()=>[n(s,null,{default:o(()=>[n(C(z))]),_:1}),t[11]||(t[11]=m(" 批量转换 ",-1))]),_:1})])):T("",!0)]),n(ee),_.value.length>0?(d(),y("div",Be,[t[12]||(t[12]=i("h3",null,"转换进度",-1)),(d(!0),y(k,null,$(_.value,l=>(d(),y("div",{key:l.file_id,class:"convert-task"},[i("div",Ie,[i("span",null,b(l.fileName),1),i("span",Me,b(l.statusText),1)]),n(r,{percentage:l.progress,status:l.status==="failed"?"exception":l.status==="completed"?"success":""},null,8,["percentage","status"])]))),128))])):T("",!0)]),_:1})])}}},Ge=ye(Pe,[["__scopeId","data-v-c068c2fb"]]);export{Ge as default};
