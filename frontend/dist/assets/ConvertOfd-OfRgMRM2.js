import{r as F,s as Q,o as W,E as u,c as C,a as p,d as n,w as l,e as _,v as X,x as b,b as d,f as h,y as Z,z as m,F as I,h as M,t as S,A as ee,g as te,l as $,B as N,G as se,C as ne,k as oe,D as le}from"./index-CEly86vT.js";import{g as ae,u as ie,a as re,d as de,c as ue,b as ce,e as pe}from"./convert-s7j5aenr.js";import{_ as fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-B9ygI19o.js";const _e={class:"convert-ofd"},me={class:"card-header"},ve={key:0,class:"uploading-section"},ge={class:"upload-item-info"},ye={class:"upload-percent"},xe={class:"file-list-section"},Ce={class:"section-header"},he={key:1,class:"converting-section"},Se={class:"task-info"},Fe={class:"task-status"},B="conversion_map_ofd",be=".ofd",De={__name:"ConvertOfd",setup(Te){const g=F([]),D=F(!1),v=F([]),f=F([]),y=F(K()),O=Q(()=>g.value.filter(e=>["ofd"].includes(e.file_type.toLowerCase())));W(()=>{T()});const T=async()=>{D.value=!0;try{const t=(await ae()).files||[];g.value=t.map(s=>({...s,conversion_id:y.value[s.id]||s.conversion_id}))}catch(e){u.error("获取文件列表失败: "+(e.message||"未知错误"))}finally{D.value=!1}},k=e=>e.size>52428800?(u.error("文件大小不能超过 50MB"),!1):!0,z=async e=>{const{file:t}=e,s=t.uid||Date.now(),c={uid:s,name:t.name,percent:0,status:""};v.value.push(c);try{await ie(t,a=>{const i=v.value.find(x=>x.uid===s);i&&(i.percent=a)});const r=v.value.find(a=>a.uid===s);r&&(r.status="success"),u.success(`文件 ${t.name} 上传成功`),setTimeout(()=>{const a=v.value.findIndex(i=>i.uid===s);a>-1&&v.value.splice(a,1)},2e3),T()}catch(r){const a=v.value.find(i=>i.uid===s);a&&(a.status="exception"),u.error("上传失败: "+(r.message||"未知错误"))}},E=async e=>{try{const t={file_id:e.id,fileName:e.original_name,progress:0,status:"processing",statusText:"转换中...",conversion_id:null};f.value.push(t);const s=await ue(e.id);t.conversion_id=s.conversion_id,await L(t)}catch(t){u.error(`转换失败: ${t.message||"未知错误"}`);const s=f.value.findIndex(c=>c.file_id===e.id);s>-1&&(f.value[s].status="failed",f.value[s].statusText="转换失败",f.value[s].progress=0)}},L=async e=>{let s=0;const c=async()=>{try{const r=await pe(e.conversion_id);if(e.progress=r.progress||0,e.statusText=G(r.status),r.status==="completed"){e.status="completed",e.progress=100,u.success(`${e.fileName} 转换成功`);const a=g.value.findIndex(i=>i.id===e.file_id);a>-1&&(g.value[a].status="converted",g.value[a].conversion_id=e.conversion_id),Y(e.file_id,e.conversion_id),setTimeout(()=>{const i=f.value.findIndex(x=>x.file_id===e.file_id);i>-1&&f.value.splice(i,1)},2e3);return}if(r.status==="failed"){e.status="failed",e.statusText=r.error_message||"转换失败",u.error(`${e.fileName} 转换失败`);return}s++,s<30?setTimeout(c,1e3):(e.status="failed",e.statusText="转换超时",u.error(`${e.fileName} 转换超时`))}catch(r){e.status="failed",e.statusText="查询状态失败",console.error("查询转换状态失败",r)}};await c()},P=e=>{const t=ce(e),s=document.createElement("a");s.href=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),u.success("开始下载 PDF")},U=e=>{const t=re(e.id),s=document.createElement("a");s.href=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),u.success("开始下载原文件")},A=async e=>{try{await le.confirm(`确认删除文件"${e.original_name}"吗？删除后无法恢复。`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await de(e.id),g.value=g.value.filter(s=>s.id!==e.id);const t={...y.value};delete t[e.id],y.value=t,localStorage.setItem(B,JSON.stringify(y.value)),u.success("已删除原文件")}catch(t){t!=="cancel"&&u.error("删除失败: "+(t.message||"未知错误"))}},V=e=>e?e<1024?e+" B":e<1024*1024?(e/1024).toFixed(2)+" KB":(e/(1024*1024)).toFixed(2)+" MB":"0 B",J=e=>{if(!e)return"";const t=new Date(e),s=t.getFullYear(),c=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0"),x=String(t.getSeconds()).padStart(2,"0");return`${s}-${c}-${r} ${a}:${i}:${x}`},G=e=>({pending:"等待中...",processing:"转换中...",completed:"转换完成",failed:"转换失败"})[e]||e;function K(){try{const e=localStorage.getItem(B);return e?JSON.parse(e):{}}catch(e){return console.error("加载本地 conversion_map 失败",e),{}}}function Y(e,t){y.value={...y.value,[e]:t},localStorage.setItem(B,JSON.stringify(y.value))}return(e,t)=>{const s=_("el-icon"),c=_("el-upload"),r=_("el-progress"),a=_("el-button"),i=_("el-table-column"),x=_("el-tag"),q=_("el-table"),H=_("el-divider"),R=_("el-card"),j=X("loading");return p(),C("div",_e,[n(R,null,{header:l(()=>[d("div",me,[n(s,null,{default:l(()=>[n(h(oe))]),_:1}),t[0]||(t[0]=d("span",null,"OFD 转 PDF",-1))])]),default:l(()=>[n(c,{class:"upload-demo",drag:"",multiple:!0,accept:be,"before-upload":k,"http-request":z,"show-file-list":!1,"auto-upload":!0,style:{"margin-bottom":"20px"}},{tip:l(()=>[...t[1]||(t[1]=[d("div",{class:"el-upload__tip"}," 仅支持 OFD，单个文件不超过 50MB ",-1)])]),default:l(()=>[n(s,{class:"el-icon--upload"},{default:l(()=>[n(h(Z))]),_:1}),t[2]||(t[2]=d("div",{class:"el-upload__text"},[m(" 将文件拖到此处，或 "),d("em",null,"点击上传")],-1))]),_:1}),v.value.length>0?(p(),C("div",ve,[t[3]||(t[3]=d("h3",null,"正在上传",-1)),(p(!0),C(I,null,M(v.value,o=>(p(),C("div",{key:o.uid,class:"upload-item"},[d("div",ge,[d("span",null,S(o.name),1),d("span",ye,S(o.percent)+"%",1)]),n(r,{percentage:o.percent,status:o.status},null,8,["percentage","status"])]))),128))])):b("",!0),d("div",xe,[d("div",Ce,[t[5]||(t[5]=d("h3",null,"OFD 文件列表",-1)),n(a,{type:"primary",size:"small",onClick:T},{default:l(()=>[n(s,null,{default:l(()=>[n(h(te))]),_:1}),t[4]||(t[4]=m(" 刷新列表 ",-1))]),_:1})]),ee((p(),$(q,{data:O.value,style:{width:"100%"},"empty-text":"暂无 OFD 文件"},{default:l(()=>[n(i,{prop:"original_name",label:"文件名","min-width":"200"}),n(i,{prop:"file_size",label:"大小",width:"120"},{default:l(({row:o})=>[m(S(V(o.file_size)),1)]),_:1}),n(i,{prop:"file_type",label:"类型",width:"100"},{default:l(({row:o})=>[n(x,{size:"small"},{default:l(()=>[m(S(o.file_type.toUpperCase()),1)]),_:2},1024)]),_:1}),n(i,{prop:"created_at",label:"上传时间",width:"180"},{default:l(({row:o})=>[m(S(J(o.created_at)),1)]),_:1}),n(i,{label:"操作",width:"280",fixed:"right"},{default:l(({row:o})=>[n(a,{link:"",type:"primary",size:"small",onClick:w=>U(o)},{default:l(()=>[n(s,null,{default:l(()=>[n(h(N))]),_:1}),t[6]||(t[6]=m(" 下载原文件 ",-1))]),_:1},8,["onClick"]),n(a,{link:"",type:"danger",size:"small",onClick:w=>A(o)},{default:l(()=>[n(s,null,{default:l(()=>[n(h(se))]),_:1}),t[7]||(t[7]=m(" 删除原文件 ",-1))]),_:1},8,["onClick"]),t[10]||(t[10]=d("br",null,null,-1)),o.status!=="converted"&&o.status!=="converting"?(p(),$(a,{key:0,link:"",type:"primary",size:"small",onClick:w=>E(o)},{default:l(()=>[n(s,null,{default:l(()=>[n(h(ne))]),_:1}),t[8]||(t[8]=m(" 转换为PDF ",-1))]),_:1},8,["onClick"])):b("",!0),o.conversion_id?(p(),$(a,{key:1,link:"",type:"success",size:"small",onClick:w=>P(o.conversion_id)},{default:l(()=>[n(s,null,{default:l(()=>[n(h(N))]),_:1}),t[9]||(t[9]=m(" 下载PDF ",-1))]),_:1},8,["onClick"])):b("",!0)]),_:1})]),_:1},8,["data"])),[[j,D.value]])]),n(H),f.value.length>0?(p(),C("div",he,[t[11]||(t[11]=d("h3",null,"转换进度",-1)),(p(!0),C(I,null,M(f.value,o=>(p(),C("div",{key:o.file_id,class:"convert-task"},[d("div",Se,[d("span",null,S(o.fileName),1),d("span",Fe,S(o.statusText),1)]),n(r,{percentage:o.progress,status:o.status==="failed"?"exception":o.status==="completed"?"success":""},null,8,["percentage","status"])]))),128))])):b("",!0)]),_:1})])}}},Me=fe(De,[["__scopeId","data-v-833de257"]]);export{Me as default};
